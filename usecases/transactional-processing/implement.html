<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Implement Transactional Processing - Hadron | event streaming, workflow orchestration &amp; messaging</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="The Hadron user guide">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../../favicon.svg">
        
        
        <link rel="shortcut icon" href="../../favicon.png">
        
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        
        <link rel="stylesheet" href="../../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><li class="part-title">Overview</li><li class="chapter-item expanded "><a href="../../index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../overview/quick-start.html"><strong aria-hidden="true">1.1.</strong> Quick Start</a></li></ol></li><li class="chapter-item expanded "><a href="../../overview/kubernetes.html"><strong aria-hidden="true">2.</strong> Kubernetes</a></li><li class="chapter-item expanded "><a href="../../overview/events.html"><strong aria-hidden="true">3.</strong> Events</a></li><li class="chapter-item expanded "><a href="../../overview/streams.html"><strong aria-hidden="true">4.</strong> Streams</a></li><li class="chapter-item expanded "><a href="../../overview/pipelines.html"><strong aria-hidden="true">5.</strong> Pipelines</a></li><li class="chapter-item expanded "><a href="../../overview/exchanges.html"><strong aria-hidden="true">6.</strong> Exchanges</a></li><li class="chapter-item expanded "><a href="../../overview/endpoints.html"><strong aria-hidden="true">7.</strong> Endpoints</a></li><li class="chapter-item expanded "><a href="../../overview/producers-consumers.html"><strong aria-hidden="true">8.</strong> Producers &amp; Consumers</a></li><li class="chapter-item expanded "><a href="../../overview/monitoring.html"><strong aria-hidden="true">9.</strong> Monitoring</a></li><li class="chapter-item expanded affix "><li class="part-title">Use Cases</li><li class="chapter-item expanded "><a href="../../usecases/local-development.html"><strong aria-hidden="true">10.</strong> Local Development</a></li><li class="chapter-item expanded "><a href="../../usecases/service-provisioning.html"><strong aria-hidden="true">11.</strong> Service Provisioning</a></li><li class="chapter-item expanded "><a href="../../usecases/transactional-processing.html"><strong aria-hidden="true">12.</strong> Transactional Processing</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../usecases/transactional-processing/learn.html"><strong aria-hidden="true">12.1.</strong> What is Transactional Processing</a></li><li class="chapter-item expanded "><a href="../../usecases/transactional-processing/implement.html" class="active"><strong aria-hidden="true">12.2.</strong> Implement Transactional Processing</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Reference</li><li class="chapter-item expanded "><a href="../../reference/tokens.html"><strong aria-hidden="true">13.</strong> Tokens</a></li><li class="chapter-item expanded "><a href="../../reference/streams.html"><strong aria-hidden="true">14.</strong> Streams</a></li><li class="chapter-item expanded "><a href="../../reference/pipelines.html"><strong aria-hidden="true">15.</strong> Pipelines</a></li><li class="chapter-item expanded "><a href="../../reference/exchanges.html"><strong aria-hidden="true">16.</strong> Exchanges</a></li><li class="chapter-item expanded "><a href="../../reference/endpoints.html"><strong aria-hidden="true">17.</strong> Endpoints</a></li><li class="chapter-item expanded "><a href="../../reference/clients.html"><strong aria-hidden="true">18.</strong> Clients</a></li><li class="chapter-item expanded "><a href="../../reference/cli.html"><strong aria-hidden="true">19.</strong> CLI</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Hadron | event streaming, workflow orchestration &amp; messaging</h1>

                    <div class="right-buttons">
                        
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#implement-transactional-processing" id="implement-transactional-processing">Implement Transactional Processing</a></h1>
<p><small><i>This chapter builds upon the ideas established in the previous chapter <a href="./learn.html">What is Transactional Processing</a> and it is recommended to have a firm understanding of that content before continuing here.</i></small></p>
<p>Armed with the knowledge of event identity, we are now ready to implement our own transactional processing system.</p>
<p>For this use case we will make the following starting assumptions:</p>
<ul>
<li>We are using an RDBMS (like PostgreSQL or CockroachDB) for application state.</li>
<li>We are using the <a href="./learn.html#establishing-identity"><code>OutTableIdentity</code> pattern</a> to transactionally generate our events.</li>
<li>We are using a microservices model, so we have multiple out-tables each in its own database schema (think namespace except for a database) owned by a different microservice.</li>
<li>Every event published to our Hadron Stream is coming from one of our microservice out-tables. Let's say our Stream is named <code>events</code>.</li>
</ul>
<p>What properties does this model have?</p>
<ul>
<li>Every event on our Stream will have a guaranteed unique identity based on the combination of the <code>id</code> and <code>source</code> fields.</li>
<li>Duplicates may still exist, but we know they are duplicates based on the <code>id</code> and <code>source</code> field combination. Our implementation below will easily deal with such duplicates.</li>
<li>As requirements evolve, we can seamlessly add new microservices to our system following this same pattern, and our uniqueness properties will still hold.</li>
</ul>
<p>This is not the only way to implement a pattern like this, but it is a great stepping stone which can be adapted to your specific use cases.</p>
<h3><a class="header" href="#transactional-consumers" id="transactional-consumers">Transactional Consumers</a></h3>
<p>Given our starting assumptions and the properties of our model, we are ready to implement a transactional processing algorithm for our consumers.</p>
<p>First, we'll show what this looks like for Streams, then we'll show what this looks like for Pipelines.</p>
<h4><a class="header" href="#stream-consumers" id="stream-consumers">Stream Consumers</a></h4>
<p>For any given microservice, we will need an in-table. For transactional processing, an in-table is the logical counterpart to an out-table, but is far more simple. The in-table in this case needs only two columns, <code>id</code> and <code>source</code>, corresponding to an event's <code>id</code> and <code>source</code> fields. The in-table will also have a compound primary key over both of these fields.</p>
<p>Time to implement. Our microservice will have a live subscription to our Stream <code>events</code>, and when an event is received, the algorithm of the event handler will be roughly as follows:</p>
<ul>
<li>Open a new transaction with our database.</li>
<li>Attempt to write a new row to the in-table using the event's <code>id</code> and <code>source</code> fields as values for their respective columns.
<ul>
<li>If an error is returned indicating a primary key violation, then we know that we've already processed this event. Close the database transaction. Return a success response from the event handler. Done.</li>
<li>Else, if no error, then continue.</li>
</ul>
</li>
<li>Now time for business logic. Do whatever it is your microservice needs to do. Manipulate some rows in the database using the open transaction. Whatever.</li>
<li>If your business logic needs to produce a new event as part of its business logic, then craft the new event, and write it to the out-table.</li>
<li>Commit the database transaction. If errors take place, no worries. Just return the error from the event handler and a retry will take place.</li>
<li>Finally, return a success from the event handler. Done!</li>
</ul>
<p>For cases where a new event was generated as part of the business logic, the out-table is already setup to ship these events over to Hadron.</p>
<p>The code implementing this model can be found here: <a href="https://github.com/hadron-project/hadron/tree/main/examples/stream-transactional-processing">examples/stream-transactional-processing</a>.</p>
<h4><a class="header" href="#pipeline-consumers" id="pipeline-consumers">Pipeline Consumers</a></h4>
<p>For Pipeline consumers, the in-table needs four columns, <code>id</code>, <code>source</code>, <code>stage</code> and <code>output</code>. The in-table will have a compound primary key over the columns <code>id</code>, <code>source</code> and <code>stage</code>.</p>
<p>Let's do this. Our microservice will have a Pipeline stage subscription to whatever Pipeline stages it should process, and when an event is received, the algorithm of the event handler will be roughly as follows:</p>
<ul>
<li>Open a new transaction with our database.</li>
<li>Query the in-table using the table's primary key, where <code>id</code> is the root event's <code>id</code>, <code>source</code> is the root event's <code>source</code>, and <code>stage</code> is the name of the stage being processed.
<ul>
<li>If a row is returned, then we know that we've already processed this root event for this stage, and the row contains the output event which our Pipeline stage handler needs to return. Close the database transaction. Return the output event. Done.</li>
<li>Else, if no row is found, then this event has not yet been processed. Continue.</li>
</ul>
</li>
<li>Now time for business logic. Do whatever it is your microservice needs to do. Manipulate some rows in the database using the open transaction, use the root event or any of the dependency events of this Pipeline stage. Whatever.</li>
<li>Pipeline stage handlers are required to return an output event indicating success. Construct a new output event. For simplicity, use the <code>id</code> of the root event and simply make the <code>source</code> something unique to this microservice's Pipeline stage.</li>
<li>Using the open database transaction, write a new row to the in-table where <code>id</code> is the root event's <code>id</code>, <code>source</code> is the root event's <code>source</code>, <code>stage</code> is the name of the stage being processed, and <code>output</code> is the serialized bytes of our new output event.</li>
<li>Commit the database transaction. If errors take place, no worries. Just return the error from the event handler and a retry will take place.</li>
<li>Finally, return the output event from the event handler. Done!</li>
</ul>
<p>With Pipelines, we are able to model all of the workflows of our applications, even spanning across multiple microservices, teams, and even system boundaries. Because Pipelines require an output event to be returned from stage consumers, we do not need an independent out-table process to ship these events over to Hadron.</p>
<p>The code implementing this model can be found here: <a href="https://github.com/hadron-project/hadron/tree/main/examples/pipeline-transactional-processing">examples/pipeline-transactional-processing</a>.</p>
<h3><a class="header" href="#next-steps" id="next-steps">Next Steps</a></h3>
<p>Now that you've seen the algorithms for implementing a transactional processing models, it would be good to:</p>
<ul>
<li><strong>Dive into the code:</strong> follow the links provided above to see the reference implementation code.</li>
<li><strong>Copy the code and modify it:</strong> if you need to implement your own transactional processing system, the reference code is a great stepping stone.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../../usecases/transactional-processing/learn.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../../reference/tokens.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../../usecases/transactional-processing/learn.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../../reference/tokens.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
