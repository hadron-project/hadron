Schema Management
=================
All Hadron resources, including Namespaces, Streams, Pipelines, RPC Endpoints, et cetera, are defined using the Hadron Schema Management system.

The guiding principals of the Hadron Schema Management system are as follows:
- Must be easy to use, and intuitive.
- Must be natively supported by the hadron CLI, no external tools needed.
- Must be explicit, clear, well-defined.
- Must be idempotent.

The Hadron CLI is used for all aspects of schema management, and schema management files should be committed to one's code repository. Very importantly, Hadron schema management is designed to be idempotent, ensuring that the cluster does not end up in an unexpected state as teams roll changes to their applications.

Hadron uses YAML for its Data Definition Language (DDL), and is structured as groupings of files akin to traditional RDBMS schema migration systems. Simply run `hadron schema init {branchName}` to create a new schema management directory. Here, we will use `schema-for-service-abc` as the value for `{branchName}` (more on this later). The Hadron CLI will use the directory `hadron-schema` by default, but this value may be overridden. This will give you a directory structure as follows:

```bash
hadron-schema/
├── 1608743979-initial-commit.down.yaml
└── 1608743979-initial-commit.up.yaml
```

Let's break down each of these files. The leading timestamp, generated at the time of the Hadron CLI invocation, will ensure that files stay sorted, and the Hadron CLI will execute them according to their timestamp order. The `initial-commit` segment in the middle of the filename is generated by the Hadron CLI as part of generating the new schema management directory. And finally, the `.up.yaml` & `.down.yaml` identify the files as being used for committing new schema changes or reverting changes respectively.

Here are the internals of the `1608743979-initial-commit.up.yaml` file:

```yaml
kind: ChangeSet
branch: schema-for-service-abc
timestamp: 1608743979
action: commit
changes: [] # Add your schema changes here.
```

And the internals of `1608743979-initial-commit.down.yaml`:

```yaml
kind: ChangeSet
branch: schema-for-service-abc
timestamp: 1608743979
action: revert
changes: [] # Add your schema changes here. These should be the inverse of
            # the changes added by the corresponding *.up.yaml file.
```

### Branches & Timestamps
In Hadron, schema files declare a changeset object with a branch name and a timestamp. The branch establishes a link between consecutive changesets ordered by timestamp, and the timestamp should be considered the ID of the changeset. Once a changeset has been applied, it will not be applied again unless it is first reverted. The following Hadron CLI commands are used for committing and reverting changes:

- `hadron schema up`: apply all `.up.yaml` files in the schema management directory to the Hadron cluster.
- `hadron schema down`: apply all `.down.yaml` files in the schema management directory to the Hadron cluster.

### New ChangeSets
New changeset files can be added to the schema management directory with the following command: `hadron schema new {fileName}`. This will create a new pair of schema changeset up/down files in the schema management directory. The branch name used for the new changeset files will match the branch name of the most recently generated changeset file in the schema management directory.

Branches can be thought of as being aking to Git branches in some ways. The DDL of the objects needed by a single microservice should exist on a single branch so that the changes on the branch can be committed and reverted without impacting other services. However, there is no one way of doing this. Teams may find better branching strategies with different levels of schema change isolation as needed.

### DDL Statements
Each changeset accepts a series of DDL statements in the `changes` list, which are together transactionally applied to the Hadron cluster. All DDL statements have a similar top-level structure composed of the required `kind` & `spec` fields. Most DDL statements also allow for the optional `metadata` field.

The following is a list of accepted DDL statements by `kind`, along with links to their full DDL spec.

- [`Namespace`](./namespaces.md#ddl)
- [`Stream`](./streams.md#ddl)
- [`Pipeline`](./pipelines.md#ddl)
- [`Endpoint`](./rpc.md#ddl)
