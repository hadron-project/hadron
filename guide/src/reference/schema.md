Schema Management
=================
All Hadron resources including Namespaces, Streams, Pipelines, RPC Endpoints, etc, are defined using the Hadron Schema Management system.

The guiding principals of the Hadron Schema Management system are as follows:
- Must be easy to use, convenient, and intuitive.
- Must be natively supported by the hadron CLI, no external tools needed.
- Must be explicit, clear, well-defined.
- Must be idempotent.

The Hadron CLI is used for all aspects of schema management, and schema management files should be committed to one's code repository. Very importantly, Hadron schema management is designed to be idempotent, ensuring that the cluster does not end up in an unexpected state as teams roll changes to their applications.

Hadron uses YAML for its schema language. Simply run `hadron schema init {branchName}` to create a new schema management directory. Here, we will use `service-xyz` as the value for `{branchName}` (more on this later). The Hadron CLI will use the directory `hadron-schema` by default, but this value may be overridden. This will give you a directory structure as follows:

```bash
hadron-schema/
├── .hadron-state.yaml
└── 1608743979-initial.yaml
```

Let's break down each of these files. The leading timestamp, generated at the time of the Hadron CLI invocation, will ensure that files stay sorted, and the Hadron CLI will execute them according to their timestamp order. The `initial` segment in the middle of the timestamped filename is generated by the Hadron CLI as part of generating the new schema management directory. And finally, the `.hadron-state.yaml` file holds state information related to this branch of schema changes, the last applied timestamp, and other info — which is always synchronized with the Hadron cluster. The state file should never be manually edited.

Here are the internals of the `1608743979-initial.yaml` file:

```yaml
# Add your schema changes here. Each schema statement should be delimited by
# a line with the text `---` which indicates the start of a new YAML object.
#
# All of the schema statements in this file will be transactionally applied
# to the system as a whole.
#
# Here is an example `Namespace` declaration:
---
kind: Namespace
spec:
  name: example-namespace

# See the docs at https://docs.hadron.rs/guide/reference/schema.html
```

This is a schema file. In Hadron, schema files declare a set of schema statements to be applied to the Hadron cluster. The Hadron CLI ensures that all schema file names are prefixed with a valid timestamp, which is used to order the statements before attempting to apply them to the cluster.

And the internals of `.hadron-state.yaml`:

```yaml
# NOTE: this file was generated by the Hadron CLI. Do not edit.
branch: service-xyz
```

This is the state management file. This file declares the provided branch name, establishing a link between all schema files in the respective directory. This file is managed by the Hadron CLI itself, and should not be manually modified. As schema files are applied to the cluster, their timestamps are record in this file under the `lastAppliedTimestamp` key. If a schema file's timestamp is earlier than the `lastAppliedTimestamp`, then it will not be applied.

Simply run the following command `hadron schema apply` to apply any outstanding schema files in this directory to the cluster. The Hadron cluster stores the last applied timestamp per branch, and the Hadron CLI refreshes this data before every attempt to apply schema changes.

### New Schema Files
New schema files can be added to the schema management directory with the following command: `hadron schema new {fileName}`. This will create a new schema file in the schema management directory. The Hadron CLI will automatically prefix the new file with the current timestamp.

### Idempotent Workflow & Compaction
The Hadron schema management system is designed to be idempotent based on the simple concepts of branch name and timestamp. This helps to ensure that the cluster does not get into an undesired state due to accidentally applying old changes. This systems has no concept of "rollbacks". We take the fail-forward approach.

Over time, it will be common that a large number of schema files will build up within a schema management directory. Run the `hadron schema compact` command to combine all schema statements into the latest schema file, deleting the old schema files once it is safe to do so.
- Ordering of all schema statements is strictly preserved during compaction of schema files.
- Hadron will only compact schema files which are older than the `lastAppliedTimestamp`.

### Schema Statements
The following is a list of accepted schema statements by `kind`, along with links to their full schema spec.

- [`Namespace`](./namespaces.md#schema)
- [`Stream`](./streams.md#schema)
- [`Pipeline`](./pipelines.md#schema)
- [`Endpoint`](./rpc.md#schema)

### Kubernetes Operator Schema Management
The Hadron Kubernetes Operator ships with the ability to handle all schema management based on CRDs.

This is a work in progress, but here are a few of the design goals:
- `HadronSchemaState` CRDs take the place of the `.hadron-state.yaml` files, declaring a branch name and recording the last applied schema file timestamp. The CRD will need to reference a secret containing a Hadron token which has permissions to make schema changes to the cluster.
- `HadronSchemaFile` CRDs take the place of the standard schema files, and are associated with a parent `HadronSchemaState` CRD by label.
- The operator will order `HadronSchemaFile`s when changes are detected, and then apply the latest changes in order, updating the `HadronSchemaState` CRD, which will probably back its state via ConfigMap.
