# Operator & Components
```
Author: Dodd
Status: InDesign
```

Use a strong operator pattern.
- Everything starts as CRDs except for the operator.
- Operator is a simple deployment which uses the lease system for leadership.

Streams
- A stream 1:1 corresponds to a statefulset generated by the operator.
- Stream CRD declares number of partitions, which corresponds to the number of replicas of the statefulset.
- Each pod of the statefulset is a partition leader for its partition offset corresponding to its ordinal.
- Each pod will have a service generated for it bearing a prefix defined in the CRD.
- Each service may also have an ingress created for it so that it may be exposed outside of the cluster using a shared LB & L7 hostname routing.
- Each partition will always attempt to replicate its data to two other nodes, replica assignement uses a deterministic algorithm. Clients choose durability: all, majority, none. Clients choose fsync.
- There are no leadership changes.
- Scaling down partitions equals data loss.
- Streams can be configured with optional s3 stanza for async streaming backups of partitions.

Stream Bin Interfaces
- The stream bin is DEAD SIMPLE and is composed of 4 gRPC interfaces.
- The metadata interface, which streams out the partition connection info.
- The stream pub interface, for publishing data to the implicit stream of the partition.
- The stream sub interface, for transactionally consuming data from the implicit stream of the partition.
- The pipeline sub interface, for transactionally consuming pipeline stages. This is generic, and the request will specify the pipeline & stage to consume. If it doesn't exist for the stream, then 404.
- The gRPC interface for pipelines will dynamically route the pipeline sub requests to a pipeline controller which may or may not exist on the node.

Stream K8s Watcher
- Each pod of a stream's statefulset will watch the k8s API for tokens & pipelines.
- Tokens will be added to an in-memory map for handling authN & authZ.
- Pipelines will be spawned & made available to the network interface.

Stream Multi-Region Survivability
- Through the use of data silos, S3 and the like, the data residing on each partition of a stream may be backed-up for a greater level of reliability.
- Stream statefulsets may include affinity & anit-affinity rules defined by the user to ensure pods are distributed across AZs.

Stream Clients
- Must use client-side load balancing for proper setup, especially for subscribers.
- Clients will be initialized with a seed URL. A single streaming gRPC call will be made to stream in a set of all partitions along with their internal and external URLs. The server will emit changes when detected.

Exchanges
- Exchanges generate statefulsets.
- A single service is used as the frontend for all members, and load is balanced across all pods.
- Members of an exchange are aware of each other and exchange their routing info.
- Ephemeral & RPC messaging is centralized to the exchanges.
- Exchanges are spawned with static config so nothing ever changes on an exchange other than scale.
- RPCs are fully dynamic, and can be unary or streaming, based entirely on the message variants sent.

----
