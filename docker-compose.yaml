# NOTE WELL: this is intended for local development only.
version: "3.7"
services:
  # This container will build a development image with all needed system deps,
  # and will build the app caching all work in a volume for more rapid development.
  #
  # `docker-compose run builder`
  builder:
    image: hadron-local-builder:latest
    build:
      context: .
      dockerfile: docker/Dockerfile.local.builder
    volumes:
      - hadron-build-cache:/hadron/hadrond/target
      - ./hadrond/proto:/hadron/hadrond/proto
      - ./hadrond/src:/hadron/hadrond/src
      - ./hadrond/build.rs:/hadron/hadrond/build.rs
      - ./hadrond/Cargo.toml:/hadron/hadrond/Cargo.toml
      - ./hadrond/Cargo.lock:/hadron/hadrond/Cargo.lock
      - ./hadrond/.artifacts:/.artifacts
      - ./proto:/hadron/proto
    environment:
      CARGO_HOME: "/hadron/hadrond/target/.cargo"

  # This container requires the artifacts generated from the `builder` image above. The workflow
  # is that you will build the `builder` image first, and any time you have made updates to the
  # app. Then:
  #
  # To update the local release image to use:
  # `docker-compose build --no-cache hadron`
  hadron:
    container_name: hadron
    image: hadron-local-release:latest
    build:
      context: .
      dockerfile: docker/Dockerfile.local.release
      args:
        ARTIFACT_PATH: hadrond/.artifacts/hadrond
    command: echo 'only intended for builds'
    volumes:
      - hadron-data:/usr/local/hadron/data

volumes:
  # `docker volume create hadron-build-cache`
  hadron-build-cache:
    external: true
  hadron-data: {}
